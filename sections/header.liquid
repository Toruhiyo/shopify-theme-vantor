{%- assign menu = section.settings.menu -%}
{%- assign max_visible = 7 -%}

{%- comment -%} Build filtered collection array and count {%- endcomment -%}
{%- assign nav_count = 0 -%}
{%- for col in collections -%}
  {%- if col.handle == 'all' or col.products_count == 0 -%}{%- continue -%}{%- endif -%}
  {%- assign nav_count = nav_count | plus: 1 -%}
{%- endfor -%}

<header class="header" data-header>
  <div class="header__primary">
    <div class="page-width">
      <div class="header__inner">
        <div class="header__logo">
          <a href="/">
            {%- if section.settings.logo != blank -%}
              <img
                src="{{ section.settings.logo | image_url: width: 200 }}"
                alt="{{ shop.name }}"
                width="200"
                height="40"
                loading="eager"
              >
            {%- else -%}
              {{ shop.name }}
            {%- endif -%}
          </a>
        </div>

        <nav class="header__nav" role="navigation" aria-label="{{ 'header.navigation' | t }}">
          {%- assign visible_index = 0 -%}
          {%- for col in collections -%}
            {%- if col.handle == 'all' or col.products_count == 0 -%}{%- continue -%}{%- endif -%}
            {%- assign visible_index = visible_index | plus: 1 -%}
            {%- if visible_index > max_visible -%}{%- continue -%}{%- endif -%}

            <div class="header__nav-item" data-nav-mega>
              <a href="{{ col.url }}" class="header__nav-link">
                {{ col.title }}
                <span class="header__nav-chevron">{% render 'icon-chevron' %}</span>
              </a>

              <div class="mega-menu" data-mega-panel>
                <div class="page-width">
                  {% render 'mega-menu-config', col: col %}
                </div>
              </div>
            </div>
          {%- endfor -%}

          {%- if nav_count > max_visible -%}
            <div class="header__more" data-more-dropdown>
              <button class="header__more-trigger" aria-expanded="false">
                More
                <span class="header__nav-chevron">{% render 'icon-chevron' %}</span>
              </button>
              <div class="header__more-dropdown">
                {%- assign overflow_index = 0 -%}
                {%- for col in collections -%}
                  {%- if col.handle == 'all' or col.products_count == 0 -%}{%- continue -%}{%- endif -%}
                  {%- assign overflow_index = overflow_index | plus: 1 -%}
                  {%- if overflow_index <= max_visible -%}{%- continue -%}{%- endif -%}
                  <a href="{{ col.url }}" class="header__more-link">{{ col.title }}</a>
                {%- endfor -%}
              </div>
            </div>
          {%- endif -%}
        </nav>

        <div class="header__icons">
          <div class="header__support" data-support-dropdown>
            <button class="header__support-trigger" aria-expanded="false">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              <span class="header__support-label">Support</span>
              <span class="header__nav-chevron">{% render 'icon-chevron' %}</span>
            </button>
            <div class="header__support-dropdown">
              <div class="header__support-group">
                <span class="header__support-heading">Help</span>
                <a href="/pages/contact" class="header__support-link">Contact Us</a>
                <a href="/pages/faq" class="header__support-link">FAQ</a>
              </div>
              <div class="header__support-group">
                <span class="header__support-heading">Policies</span>
                {%- if policies.shipping_policy != blank -%}
                  <a href="{{ policies.shipping_policy.url }}" class="header__support-link">Shipping Policy</a>
                {%- endif -%}
                {%- if policies.refund_policy != blank -%}
                  <a href="{{ policies.refund_policy.url }}" class="header__support-link">Returns &amp; Refunds</a>
                {%- endif -%}
                {%- if policies.terms_of_service != blank -%}
                  <a href="{{ policies.terms_of_service.url }}" class="header__support-link">Terms of Service</a>
                {%- endif -%}
                {%- if policies.privacy_policy != blank -%}
                  <a href="{{ policies.privacy_policy.url }}" class="header__support-link">Privacy Policy</a>
                {%- endif -%}
              </div>
            </div>
          </div>

          <button class="header__icon-btn" data-search-toggle aria-label="{{ 'header.search' | t }}">
            {% render 'icon-search' %}
          </button>
          <a href="{{ routes.account_url }}" class="header__icon-btn" aria-label="{{ 'header.account' | t }}">
            {% render 'icon-account' %}
          </a>
          <button class="header__icon-btn" data-cart-toggle aria-label="{{ 'header.cart' | t }}">
            {% render 'icon-cart' %}
            {%- if cart.item_count > 0 -%}
              <span class="header__cart-count">{{ cart.item_count }}</span>
            {%- endif -%}
          </button>
          <button class="header__icon-btn header__menu-toggle" data-menu-toggle aria-label="{{ 'header.menu' | t }}">
            {% render 'icon-menu' %}
          </button>
        </div>
      </div>
    </div>
  </div>
</header>

{%- comment -%} Mobile Menu {%- endcomment -%}
<div class="mobile-menu" data-mobile-menu aria-label="{{ 'header.mobile_menu' | t }}">
  <div class="mobile-menu__header">
    <span class="header__logo">{{ shop.name }}</span>
    <button class="header__icon-btn" data-menu-close aria-label="{{ 'header.close_menu' | t }}">
      {% render 'icon-close' %}
    </button>
  </div>

  <nav class="mobile-menu__nav">
    <a href="/" class="mobile-menu__link">Home</a>

    {%- for col in collections -%}
      {%- if col.handle == 'all' or col.products_count == 0 -%}
        {%- continue -%}
      {%- endif -%}

      <div class="mobile-menu__group" data-mobile-accordion>
        <button class="mobile-menu__link mobile-menu__link--parent" aria-expanded="false" data-mobile-accordion-trigger>
          <span>{{ col.title }}</span>
          <span class="mobile-menu__chevron">{% render 'icon-chevron' %}</span>
        </button>
        <div class="mobile-menu__submenu" data-mobile-accordion-content aria-hidden="true">
          <a href="{{ col.url }}" class="mobile-menu__sublink mobile-menu__sublink--all">Shop All {{ col.title }}</a>
          {% render 'mega-menu-mobile', col: col %}
        </div>
      </div>
    {%- endfor -%}

    <div class="mobile-menu__group" data-mobile-accordion>
      <button class="mobile-menu__link mobile-menu__link--parent" aria-expanded="false" data-mobile-accordion-trigger>
        <span>Support</span>
        <span class="mobile-menu__chevron">{% render 'icon-chevron' %}</span>
      </button>
      <div class="mobile-menu__submenu" data-mobile-accordion-content aria-hidden="true">
        <a href="/pages/contact" class="mobile-menu__sublink">Contact Us</a>
        <a href="/pages/faq" class="mobile-menu__sublink">FAQ</a>
        <span class="mobile-menu__sublabel">Policies</span>
        {%- if policies.shipping_policy != blank -%}
          <a href="{{ policies.shipping_policy.url }}" class="mobile-menu__grandchild-link">Shipping Policy</a>
        {%- endif -%}
        {%- if policies.refund_policy != blank -%}
          <a href="{{ policies.refund_policy.url }}" class="mobile-menu__grandchild-link">Returns &amp; Refunds</a>
        {%- endif -%}
        {%- if policies.terms_of_service != blank -%}
          <a href="{{ policies.terms_of_service.url }}" class="mobile-menu__grandchild-link">Terms of Service</a>
        {%- endif -%}
        {%- if policies.privacy_policy != blank -%}
          <a href="{{ policies.privacy_policy.url }}" class="mobile-menu__grandchild-link">Privacy Policy</a>
        {%- endif -%}
      </div>
    </div>
  </nav>
</div>

{%- comment -%} Search Overlay {%- endcomment -%}
<div class="search-overlay" data-search-overlay>
  <div class="search-overlay__inner">
    <form action="{{ routes.search_url }}" method="get" role="search">
      <input
        type="search"
        name="q"
        class="search-overlay__input"
        placeholder="{{ 'header.search_placeholder' | t }}"
        autocomplete="off"
        aria-label="{{ 'header.search' | t }}"
      >
    </form>
  </div>
</div>


{% schema %}
{
  "name": "Header",
  "tag": "div",
  "class": "header-section",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Navigation menu",
      "default": "main-menu",
      "info": "Primary navigation is auto-generated from your store's collections. This menu is kept for reference."
    }
  ]
}
{% endschema %}
