{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign featured_image = current_variant.featured_image | default: product.featured_image
-%}

<section class="section-spacing">
  <div class="page-width">
    <div class="pdp">
      {%- comment -%} Gallery {%- endcomment -%}
      <div class="pdp__gallery">
        <div class="pdp__gallery-main">
          <img
            src="{{ featured_image | image_url: width: 1200 }}"
            alt="{{ featured_image.alt | escape }}"
            width="1200"
            height="1200"
            loading="eager"
            id="pdp-main-image"
          >
        </div>

        {%- if product.images.size > 1 -%}
          <div class="pdp__gallery-thumbs">
            {%- for image in product.images -%}
              <button
                class="pdp__gallery-thumb {% if image == featured_image %}is-active{% endif %}"
                data-image-url="{{ image | image_url: width: 1200 }}"
                aria-label="{{ 'products.thumbnail' | t }} {{ forloop.index }}"
              >
                <img
                  src="{{ image | image_url: width: 120 }}"
                  alt="{{ image.alt | escape }}"
                  width="120"
                  height="120"
                  loading="lazy"
                  data-full-src="{{ image | image_url: width: 1200 }}"
                >
              </button>
            {%- endfor -%}
          </div>
        {%- endif -%}
      </div>

      {%- comment -%} Product Info (Sticky) {%- endcomment -%}
      <div class="pdp__info">
        {%- if product.vendor != blank -%}
          <p class="pdp__vendor">{{ product.vendor }}</p>
        {%- endif -%}

        <h1 class="pdp__title">{{ product.title }}</h1>

        {%- comment -%} Rating {%- endcomment -%}
        <div class="pdp__rating">
          <div class="rating">
            {%- for i in (1..5) -%}
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            {%- endfor -%}
          </div>
          <span class="pdp__rating-count">{{ 'products.reviews_count' | t: count: 47 }}</span>
        </div>

        {%- comment -%} Price {%- endcomment -%}
        <div class="pdp__price-row">
          <span class="pdp__price {% if current_variant.compare_at_price > current_variant.price %}pdp__price--sale{% endif %}">
            {{ current_variant.price | money }}
          </span>
          {%- if current_variant.compare_at_price > current_variant.price -%}
            <s class="pdp__compare-price">{{ current_variant.compare_at_price | money }}</s>
            {%- assign savings = current_variant.compare_at_price | minus: current_variant.price | times: 100 | divided_by: current_variant.compare_at_price -%}
            <span class="badge badge--sale">-{{ savings }}%</span>
          {%- endif -%}
        </div>

        {%- comment -%} Key Benefits {%- endcomment -%}
        {%- if section.blocks.size > 0 -%}
          {%- assign benefits = section.blocks | where: 'type', 'benefit' -%}
          {%- if benefits.size > 0 -%}
            <div class="pdp__benefits">
              {%- for block in benefits -%}
                <div class="pdp__benefit" {{ block.shopify_attributes }}>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  <span>{{ block.settings.text }}</span>
                </div>
              {%- endfor -%}
            </div>
          {%- endif -%}
        {%- endif -%}

        {%- comment -%} Variant Selector {%- endcomment -%}
        <form method="post" action="/cart/add" id="product-form" data-variant-selector>
          <input type="hidden" name="id" value="{{ current_variant.id }}">

          {%- unless product.has_only_default_variant -%}
            {%- for option in product.options_with_values -%}
              <div class="pdp__variants mb-md">
                <p class="pdp__variant-label">{{ option.name }}</p>
                <div class="variant-pills">
                  {%- for value in option.values -%}
                    {%- liquid
                      assign is_active = false
                      if option.selected_value == value
                        assign is_active = true
                      endif
                    -%}
                    <button
                      type="button"
                      class="variant-pill {% if is_active %}is-active{% endif %}"
                      data-option-name="{{ option.name }}"
                      data-option-value="{{ value }}"
                    >
                      {{ value }}
                    </button>
                  {%- endfor -%}
                </div>
              </div>
            {%- endfor -%}
          {%- endunless -%}

          {%- comment -%} Quantity {%- endcomment -%}
          <div class="pdp__variants mb-md">
            <p class="pdp__variant-label">{{ 'products.quantity' | t }}</p>
            <div class="qty-selector">
              <button type="button" data-qty-minus aria-label="{{ 'products.decrease_quantity' | t }}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/></svg>
              </button>
              <input type="number" name="quantity" value="1" min="1" max="99" aria-label="{{ 'products.quantity' | t }}">
              <button type="button" data-qty-plus aria-label="{{ 'products.increase_quantity' | t }}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              </button>
            </div>
          </div>

          {%- comment -%} CTAs {%- endcomment -%}
          <div class="pdp__ctas">
            {%- if current_variant.available -%}
              <button type="submit" class="btn btn--primary btn--lg btn--full">
                {{ 'products.add_to_cart' | t }} &mdash; {{ current_variant.price | money }}
              </button>
            {%- else -%}
              <button type="button" class="btn btn--primary btn--lg btn--full" disabled>
                {{ 'products.sold_out' | t }}
              </button>
            {%- endif -%}
            <a href="/checkout" class="btn btn--outline btn--lg btn--full">{{ 'products.buy_now' | t }}</a>
          </div>
        </form>

        {%- comment -%} Short Description {%- endcomment -%}
        {%- if product.description != blank -%}
          <div class="text-muted" style="font-size: 0.9375rem; line-height: 1.7;">
            {{ product.description | truncatewords: 40 }}
          </div>
        {%- endif -%}
      </div>
    </div>

    {%- comment -%} Tabs Section {%- endcomment -%}
    <div class="mt-lg" data-tabs>
      <div class="tabs" role="tablist">
        {%- assign tabs = section.blocks | where: 'type', 'tab' -%}
        {%- for block in tabs -%}
          <button
            class="tabs__tab {% if forloop.first %}is-active{% endif %}"
            data-tab="tab-{{ block.id }}"
            role="tab"
            aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
            {{ block.shopify_attributes }}
          >
            {{ block.settings.title }}
          </button>
        {%- endfor -%}
        {%- if tabs.size == 0 -%}
          <button class="tabs__tab is-active" data-tab="tab-overview" role="tab" aria-selected="true">Overview</button>
          <button class="tabs__tab" data-tab="tab-specs" role="tab" aria-selected="false">Specs</button>
        {%- endif -%}
      </div>

      {%- for block in tabs -%}
        <div class="tabs__panel {% if forloop.first %}is-active{% endif %}" data-panel="tab-{{ block.id }}" role="tabpanel">
          <div class="accordion__body">{{ block.settings.content }}</div>
        </div>
      {%- endfor -%}
      {%- if tabs.size == 0 -%}
        <div class="tabs__panel is-active" data-panel="tab-overview" role="tabpanel">
          <div class="accordion__body">{{ product.description }}</div>
        </div>
        <div class="tabs__panel" data-panel="tab-specs" role="tabpanel">
          <div class="accordion__body"><p>Specifications coming soon.</p></div>
        </div>
      {%- endif -%}
    </div>
  </div>
</section>

{%- comment -%} Sticky Mobile Bar {%- endcomment -%}
<div class="pdp-sticky-bar">
  <div class="pdp-sticky-bar__price">{{ current_variant.price | money }}</div>
  {%- if current_variant.available -%}
    <button
      class="btn btn--primary"
      onclick="document.getElementById('product-form').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}))"
    >
      {{ 'products.add_to_cart' | t }}
    </button>
  {%- else -%}
    <button class="btn btn--primary" disabled>{{ 'products.sold_out' | t }}</button>
  {%- endif -%}
</div>

<script>
  (function() {
    var thumbs = document.querySelectorAll('.pdp__gallery-thumb');
    var mainImg = document.getElementById('pdp-main-image');

    thumbs.forEach(function(thumb) {
      thumb.addEventListener('click', function() {
        thumbs.forEach(function(t) { t.classList.remove('is-active'); });
        thumb.classList.add('is-active');
        var url = thumb.dataset.imageUrl || thumb.querySelector('img').dataset.fullSrc;
        if (mainImg && url) mainImg.src = url;
      });
    });
  })();
</script>

{% schema %}
{
  "name": "Product page",
  "tag": "section",
  "class": "main-product-section",
  "settings": [],
  "blocks": [
    {
      "type": "benefit",
      "name": "Key benefit",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Benefit text",
          "default": "Free shipping over $99"
        }
      ]
    },
    {
      "type": "tab",
      "name": "Content tab",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Tab title",
          "default": "Overview"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Tab content",
          "default": "<p>Product details and information.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product page",
      "blocks": [
        { "type": "benefit", "settings": { "text": "Free shipping over $99" } },
        { "type": "benefit", "settings": { "text": "2-year warranty included" } },
        { "type": "benefit", "settings": { "text": "30-day easy returns" } },
        { "type": "tab", "settings": { "title": "Overview", "content": "<p>Product details and information.</p>" } },
        { "type": "tab", "settings": { "title": "Specs", "content": "<p>Technical specifications.</p>" } },
        { "type": "tab", "settings": { "title": "Compatibility", "content": "<p>Compatible devices and systems.</p>" } },
        { "type": "tab", "settings": { "title": "In the box", "content": "<p>What's included with your purchase.</p>" } },
        { "type": "tab", "settings": { "title": "Warranty", "content": "<p>Warranty information and terms.</p>" } }
      ]
    }
  ]
}
{% endschema %}
